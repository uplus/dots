#!/usr/bin/env zsh
# login interactive„ÅßÂÆüË°å„Åï„Çå„Çã

case $OSTYPE in
linux*)  exists_source "$HOME/.zshrc.linux" ;;
darwin*) exists_source "$HOME/.zshrc.darwin" ;;
esac

umask 077
DIRSTACKSIZE=100
disable r # zsh-builtin: Áõ¥Ââç„ÅÆ„Ç≥„Éû„É≥„Éâ„ÇíÂÆüÂäπ„Åô„Çã
autoload -Uz add-zsh-hook
autoload -Uz zmv

eval "$(dircolors -b)"
autoload -U colors && colors

#Prompt # {{{
autoload -Uz promptinit && promptinit
setopt prompt_subst         # „Éó„É≠„É≥„Éó„ÉàÂÆöÁæ©„ÅßÁΩÆ„ÅçÊèõ„Åà„Çí‰ΩøÁî®„Åô„Çã
setopt prompt_cr            # show prompt in new line, when after command finish.
setopt no_transient_rprompt # on: remove old rprompt when after execute a command.

rprompt-git() {
  git rev-parse --git-dir >&! /dev/null || return

  # branch name
  local name state color
  name=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
  state=$(git status --short | awk '{print $1}')
  if [[ $state =~ U ]]; then
    color=magenta
  elif [[ $state =~ '\?' ]]; then
    color=yellow
  elif  [[ $state =~ M ]]; then
    color=red
  else
    color=green
  fi

  # branch status
  local brace ahead behind stash
  brace=$(git status --short --branch | head -1 | grep -oe '\[.*]$')
  ahead=$(echo "${brace}" | grep -oe 'ahead [0-9]\+' | awk '{print $2}')
  behind=$(echo "${brace}" | grep -oe 'behind [0-9]\+' | awk '{print $2}')
  stash=$(git stash list | wc -l | sed -e 's/^0$//g')
  [[ -n $ahead ]] && ahead=" %F{green}$ahead%f"
  [[ -n $behind ]] && behind=" %F{red}$behind%f"
  [[ -n $stash ]] && stash=" %F{yellow}$stash%f"

  echo " [%F{$color}$name%f${ahead}${behind}${stash}]"
}

prompt-return-value() {
  echo " %(?,,%F{red} %?%f)"
}

prompt-ssh() {
  if [[ -n "${REMOTEHOST:-}${SSH_CONNECTION:-}" ]]; then
    echo " %F{37}($HOST)%f"
  fi
}

# vim„Å™„Å©ÁâπÂÆö„ÅÆbg„Ç≥„Éû„É≥„Éâ„ÇíË°®Á§∫„Åô„Çã
rprompt-bg() {
  local bg_cmds names
  bg_cmds=$(ps -o comm -T)
  names=$(echo "$bg_cmds" | grep -Eo "vim")

  if [[ -n $names ]]; then
    out=$(echo $names | head -1)
    echo " [%F{99}$out%f]"
  fi
}

export PROMPT='%F{37}%(6~|...|)%5~%F{white} %# %f'
export RPROMPT='$(prompt-return-value)$(rprompt-bg)$(rprompt-git)$(prompt-ssh)'
# }}}

#History # {{{
setopt share_history
setopt inc_append_history       #on: Â±•Ê≠¥„ÇíÂç≥Â∫ß„Å´Êõ∏„ÅçËæº„ÇÄ
setopt extended_history         #on: Â±•Ê≠¥„Å´ÊôÇ„ÇíÂàª„ÇÄ
setopt hist_no_store            #on: not add history-command to history.
setopt hist_no_functions        #on: remove functon definitions from the history list.
setopt hist_reduce_blanks       #on: reduce unnecessary blanks
setopt hist_ignore_space        #on: not add to the history if first character of the command is space.
setopt hist_ignore_dups
setopt no_hist_ignore_all_dups  #on: ÈÅéÂéª„ÅÆÂ±•Ê≠¥„Å®ÈáçË§á„Åó„Å¶„ÇÇÂâäÈô§„Åó„Å™„ÅÑ
setopt no_hist_verify           #on: history-command„ÇíÁõ¥Êé•ÂÆüË°å„Åõ„Åö„ÄÅ„Åæ„ÅöÂ±ïÈñã„Åô„Çã
SAVEHIST=100000 #file
HISTSIZE=20000  #memory
HISTFILE=~/.zsh/history
# }}}

#setopt {{{
setopt local_options          #on: Èñ¢Êï∞ÁµÇ‰∫ÜÊôÇ„Å´ÂÖ®„Å¶„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂæ©ÂÖÉ„Åô„Çã
setopt no_beep no_list_beep no_hist_beep
setopt autocd
setopt noauto_pushd
setopt pushd_to_home          #pushd„ÇíÂºïÊï∞ÁÑ°„Åó„ÅßÂÆüË°å„Åó„ÅüÊôÇ„Éõ„Éº„É†„Å´ÁßªÂãï„Åô„Çã
setopt pushd_silent
setopt interactive_comments   # can use comment
setopt equals                 # Enable "=command" feature
setopt no_flow_control    # C-s, C-q„ÇíÁÑ°Âäπ„Å´„Åô„Çã„ÄÇ
setopt clobber            # „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åß‰∏äÊõ∏„Åç„Åô„Çã‰∫ã„ÇíË®±ÂèØ
setopt rm_star_silent     # rm *„ÅÆË≠¶Âëä„ÇíÁÑ°Âäπ„Å´„Åô„Çã
setopt ZLE                #use zsh line editor
# setopt cdablevars             #on: if arguments of cd is not directory, expand as variable.

#jobs
setopt auto_resume            # background job„Çí„Åù„ÅÆ„Ç≥„Éû„É≥„ÉâÂêç„ÅßÂÜçÈñã„Åô„Çã(„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊôÇ‰∏çÂèØ)
setopt notify                 # background job„ÅåÁµÇ‰∫Ü„Åó„Åü„Çâ„Éó„É≠„É≥„Éó„Éà„ÅÆË°®Á§∫„ÇíÂæÖ„Åü„Åö„Å´Áü•„Çâ„Åõ„Çã
setopt check_jobs             # report the background  and suspendedjobs before exit.
setopt long_list_jobs

#glob
setopt extended_glob
setopt brace_ccl          # {a-c}„Çía b c„Å´Â±ïÈñã„Åô„Çã
setopt no_dot_glob
setopt mark_dirs              # Add "/" when glob.
# setopt nonomatch          #off: „Éû„ÉÉ„ÉÅ„Åó„Å™„Åã„Å£„Åü„Å®„Åç„Ç®„É©„Éº„Å´„Åõ„Åö„Åü„Å†„ÅÆÊñáÂ≠óÂàó„Å®„Åó„Å¶Êâ±„ÅÜ
# setopt numeric_glob_sort  #Êï∞ÂÄ§„ÅåÂê´„Åæ„Çå„Åü„Å®„ÅçÊï∞Â≠óÈ†Ü„Å´„ÇΩ„Éº„Éà„Åô„Çã

#complete
setopt always_lastprompt  #Ë£úÂÆå„ÅßË°å„ÇíÁßªÂãï„Åó„Å™„ÅÑ
setopt list_types         # List like "ls -F"
setopt list_packed        # Ë£úÂÆå„É™„Çπ„Éà„Çí„Å™„Çã„Åπ„ÅèÂ∞ë„Å™„ÅÑÈáè„Å´„Åô„Çã
setopt auto_param_keys    #Ëá™ÂãïË£úÂÆå„Åï„Çå„Çã‰ΩôÂàÜ„Å™„Ç´„É≥„Éû„Å™„Å©„ÇíÈÅ©ÂÆúÂâäÈô§„Åó„Å¶„Çπ„É†„Éº„Ç∫„Å´ÂÖ•Âäõ„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
setopt auto_param_slash   #„Éá„Ç£„É¨„ÇØ„Éà„É™Âêç„ÅÆË£úÂÆå„ÅßÊú´Â∞æ„ÅÆ/„ÇíËá™ÂãïÁöÑ„Å´‰ªòÂä†„Åó„ÄÅÊ¨°„ÅÆË£úÂÆå„Å´ÂÇô„Åà„Çã
setopt auto_remove_slash  #„Çπ„É©„ÉÉ„Ç∑„É•„ÅåË£úÂÆå„Åï„Çå„ÅüÂæå„ÄÅ;„ÇÑ„Çπ„Éö„Éº„Çπ„ÇíÂÖ•Âäõ„Åó„Åü„ÇâËá™ÂãïÁöÑ„Å´„Åù„ÅÆ„Çπ„É©„ÉÉ„Ç∑„É•„ÇíÊ∂à„Åô

setopt list_rows_first    # ÂÄôË£ú„ÇíÁßªÂãï„Åô„Çã„Å®„ÅçÊ®™„Å´ÈÄ≤„ÇÄ
setopt no_list_ambiguous  #on: ÂÖ±ÈÄöÈÉ®ÂàÜ„ÇíË£úÂÆå„Åó„Å¶„É™„Çπ„Éà„ÅØË°®Á§∫„Åó„Å™„ÅÑ

# auto_list auto_menu bash_auto_list glob_complete hash_list_all list_ambiguous menu_complete rec_exact
# setopt auto_list          #Ë£úÂÆå„É™„Çπ„ÉàÊúâÂäπ
# setopt no_menu_complete   #

# }}}

#antigen # {{{
antigen_path="$HOME/.zsh/antigen/antigen.zsh"
if [[ ! -f $antigen_path ]]; then
  echo "antigen install?(y/N)"
  read -k 1 key
  if [[ $key =~ [yY] ]]; then
    git clone https://github.com/zsh-users/antigen.git .zsh/antigen
  fi
  unset key
fi

if [[ -f $antigen_path ]]; then
  source $HOME/.zsh/antigen/antigen.zsh
  antigen bundle zsh-users/zsh-syntax-highlighting
  antigen bundle m4i/cdd
  antigen bundle zsh-users/zaw
fi
unset antigen_path
# }}}

#zsh completion system
autoload -U compinit

#require before compinit
antigen bundle zsh-users/zsh-completions

compinit

#requrie after compinit
exists_source $HOME/.zsh.completion

source $HOME/.antigen/repos/*cdd.git/cdd
add-zsh-hook chpwd _cdd_chpwd

autoload -Uz chpwd_recent_dirs cdr
add-zsh-hook chpwd chpwd_recent_dirs
zstyle ':chpwd:*' recent-dirs-max 500
zstyle ':chpwd:*' recent-dirs-default true
zstyle ':chpwd:*' recent-dirs-pushd true
zstyle ':chpwd:*' recent-dirs-file "$HOME/.zsh/chpwd-recent-dirs"
zstyle ':completion:*:*:cdr:*:*' menu selection

exists_source $HOME/.zsh.functions
exists_source $HOME/.zsh.aliases

add-zsh-hook precmd autols
add-zsh-hook precmd ud-add

#zstyle completion {{{
zstyle ':completion:*' group-name ''
zstyle ':completion:*' verbose true
zstyle ':completion:*' list-separator '(:>)'

zstyle ':completion:*' auto-description 'specify: %d'
zstyle ':completion:*' completer _expand _complete _correct _approximate
zstyle ':completion:*' menu select=2
zstyle ':completion:*:default' menu select=2    #Ë£úÂÆåÂÄôË£ú„ÇíËâ≤‰ªò„Åë„Åô„Çã
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}

zstyle ':completion:*' list-prompt %SAt %p: Hit TAB for more, or the character to insert%s
zstyle ':completion:*' matcher-list '' 'm:{a-z}={A-Z}' 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=* l:|=*'

zstyle ':completion:*' menu select=long
zstyle ':completion:*' select-prompt %SScrolling active: current selection at %p%s
zstyle ':completion:*' use-compctl false
zstyle ':completion:*' use-cache yes

zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#)*=0=01;31'
zstyle ':completion:*:kill:*' command 'ps -u $USER -o pid,%cpu,tty,cputime,cmd'

# }}}

#keybind # {{{
bindkey -e
autoload -Uz edit-command-line
zle -N edit-command-line

# emacs bind # {{{
bindkey "^A" beginning-of-line
bindkey "^E" end-of-line
bindkey "^F" forward-char
bindkey "^B" backward-char
bindkey "^D" delete-char
bindkey "^H" backward-delete-char
bindkey "^W" backward-kill-word
bindkey "^K" kill-line
bindkey "^U" backward-kill-line
bindkey "^N" down-line-or-history
bindkey "^P" up-line-or-history
bindkey "n" history-search-forward
bindkey "p" history-search-backward
# }}}

bindkey "^L" clear-screen
bindkey "^M" accept-line
bindkey "^G" send-break
bindkey "^Q" push-line
bindkey "^V" quoted-insert

bindkey "^I" expand-or-complete
bindkey "^O" accept-line-and-down-history
bindkey "^T" transpose-chars
bindkey "^Y" yank

# Slash
bindkey "^_" undo
# insert
bindkey "^[[2~" overwrite-mode
# delete
bindkey "^[[3~" delete-char
# backspace
bindkey "^?" backward-delete-char

# <S-Tab>
bindkey "^[[Z" reverse-menu-complete

# zaw
bindkey "^X^X" zaw

# cursor-key and other # {{{
bindkey "^[[A" up-line-or-history
bindkey "^[[B" down-line-or-history
bindkey "^[[C" forward-char
bindkey "^[[D" backward-char
bindkey "^[OA" up-line-or-history
bindkey "^[OB" down-line-or-history
bindkey "^[OC" forward-char
bindkey "^[OD" backward-char
bindkey "^[OH" beginning-of-line
bindkey "^[OF" end-of-line
# }}}

# alt-bind # {{{
bindkey "^[b" backward-word
bindkey "^[f" forward-word
bindkey "^[n" history-search-forward
bindkey "^[p" history-search-backward

bindkey "^[w" kill-word
bindkey "^[y" vi-yank-whole-line
bindkey "^[q" push-line
bindkey "^[e" edit-command-line
bindkey "^[h" run-help
# }}}

  ## original keybind functions # {{{
  zle_percol_history(){
    zle reset-prompt
    local cmd="$(history -nr 0 | awk '!a[$0]++' | percol --query "$LBUFFER")"

    if [[ -n $cmd ]]; then
      BUFFER="$cmd"
      zle accept-line
    fi
  }
  zle -N zle_percol_history
  bindkey '^S' zle_percol_history

  zle_percol_cdr(){
    zle reset-prompt
    local dir=$(cdr -l | awk '{ $1=""; sub(/^ /, "", $0); print }' | grep "$LBUFFER" | percol --query "$LBUFFER")

    if [[ -n $dir ]]; then
      BUFFER="cd $dir"
      zle accept-line
    fi
  }
  zle -N zle_percol_cdr
  bindkey '^R' zle_percol_cdr

  zle_percol_select_file(){
    zle reset-prompt
    local -a array
    array+=${(z)LBUFFER}
    shift array

    local dir file file_path
    dir="${$(relative "$array[-1]"):-.}"
    file="$(cd "$dir" && find . -type f 2>/dev/null | percol)"
    file_path="$(relative "$dir/$file")"

    if [[ -n $file ]]; then
      BUFFER="${BUFFER%"$array[-1]"}$file_path"
      CURSOR=${#BUFFER}
    fi
  }
  zle -N zle_percol_select_file
  bindkey '^O' zle_percol_select_file

  zle_play_music(){
    zle reset-prompt
    play-music </dev/tty
  }
  zle -N zle_play_music
  bindkey '^Xm' zle_play_music

  zle_pry(){
    BUFFER=pry
    zle accept-line
  }
  zle -N zle_pry
  bindkey 'p' zle_pry

  zle_todo(){
    BUFFER='memo todo'
    zle accept-line
  }
  zle -N zle_todo
  bindkey 't' zle_todo

  zle_memo(){
    zle push-line
    BUFFER='memo '
    CURSOR=${#BUFFER}
  }
  zle -N zle_memo
  bindkey 'm' zle_memo

  # }}}
# }}}

#Load local config
exists_source $HOME/.zshrc.local
