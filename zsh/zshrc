#!/usr/bin/env zsh
# login interactive„ÅßÂÆüË°å„Åï„Çå„Çã

if [[ -z $TMUX && -n ${REMOTEHOST:-}${SSH_CONNECTION:-} ]]; then
  in_path tmux && exec tmux
fi


case "${OSTYPE:-}" in
linux*)  source "$ZSH_DOT_DIR/zshrc.linux" ;;
darwin*) source "$ZSH_DOT_DIR/zshrc.darwin" ;;
esac

LC_COLLATE=C # Don't move to zshenv.
DIRSTACKSIZE=100
fpath+=($ZSH_DOT_DIR/f)
disable r # zsh-builtin: Áõ¥Ââç„ÅÆ„Ç≥„Éû„É≥„Éâ„ÇíÂÆüÂäπ„Åô„Çã
# autoload -Uz add-zsh-hook # NOTE: call by zplug
autoload -Uz zmv

# ‰ªÆÊÉ≥Á´ØÊú´„Åß„Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å(„Éë„Çπ„ÉØ„Éº„Éâ„ÅÆËá™ÂãïÂÖ•Âäõ„Å®„Åã „ÉÄ„É°Áµ∂ÂØæ)
# zmodload zsh/zpty

eval "$(dircolors -b)"
LS_COLORS=$(echo "$LS_COLORS" | sed 's/ln=..;../ln=03;94/g')
# autoload -U colors && colors  # NOTE: call by zplug

#Prompt # {{{
autoload -Uz promptinit && promptinit
setopt prompt_subst         # „Éó„É≠„É≥„Éó„ÉàÂÆöÁæ©„ÅßÁΩÆ„ÅçÊèõ„Åà„Çí‰ΩøÁî®„Åô„Çã
setopt prompt_cr            # show prompt in new line, when after command finish.
setopt no_transient_rprompt # on: remove old rprompt when after execute a command.

# alias„Å™„Å©„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ
autoload -Uz rprompt-git

prompt-return-value(){
  echo " %(?,,%F{197} %?%f)"
}

in-ssh(){
  [[ -n "${REMOTEHOST:-}${SSH_CONNECTION:-}" ]]
}

PROMPT_SSH_COLOR=220
prompt-ssh() {
  in-ssh && echo " %F{$PROMPT_SSH_COLOR}($HOST)%f"
}

# vim„Å™„Å©ÁâπÂÆö„ÅÆbg„Ç≥„Éû„É≥„Éâ„ÇíË°®Á§∫„Åô„Çã
rprompt-bg() {
  local bg_cmds names
  bg_cmds=$(ps -o comm -T)
  names=$(echo "$bg_cmds" | grep -Eo "vim")

  if [[ -n $names ]]; then
    out=$(echo $names | head -1)
    echo " [%F{99}$out%f]"
  fi
}

prompt-color(){
  if (($UID == 0)); then
    echo 249
  elif in-ssh; then
    echo $PROMPT_SSH_COLOR
  else
    echo 198
  fi
}

prompt-symb-color(){
  if (( $UID == 0)); then
    echo 160
  else
    echo 255
  fi
}

export PROMPT='%F{$(prompt-color)}%(6~|...|)%5~%F{$(prompt-symb-color)} %# %f'
export RPROMPT='$(prompt-return-value)$(rprompt-bg)$(rprompt-git)$(prompt-ssh)'
# }}}

#History # {{{
setopt share_history
setopt inc_append_history       #on: Â±•Ê≠¥„ÇíÂç≥Â∫ß„Å´Êõ∏„ÅçËæº„ÇÄ
setopt extended_history         #on: Â±•Ê≠¥„Å´ÊôÇ„ÇíÂàª„ÇÄ
setopt hist_no_store            #on: not add history-command to history.
setopt hist_no_functions        #on: remove functon definitions from the history list.
setopt hist_reduce_blanks       #on: reduce unnecessary blanks
setopt hist_ignore_space        #on: not add to the history if first character of the command is space.
setopt hist_ignore_dups
setopt hist_ignore_all_dups     #on: ÈÅéÂéª„ÅÆÂ±•Ê≠¥„Å®ÈáçË§á„Åó„Å¶„ÇÇÂâäÈô§„Åó„Å™„ÅÑ
setopt no_hist_verify           #on: history-command„ÇíÁõ¥Êé•ÂÆüË°å„Åõ„Åö„ÄÅ„Åæ„ÅöÂ±ïÈñã„Åô„Çã
SAVEHIST=100000 #file
HISTSIZE=20000  #memory
HISTFILE=~/.zsh/history
# }}}

#setopt {{{
setopt local_options          #on: Èñ¢Êï∞ÁµÇ‰∫ÜÊôÇ„Å´ÂÖ®„Å¶„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂæ©ÂÖÉ„Åô„Çã
setopt no_beep no_list_beep no_hist_beep
setopt autocd
setopt auto_pushd
setopt pushd_to_home          #pushd„ÇíÂºïÊï∞ÁÑ°„Åó„ÅßÂÆüË°å„Åó„ÅüÊôÇ„Éõ„Éº„É†„Å´ÁßªÂãï„Åô„Çã
setopt pushd_silent
setopt interactive_comments   # can use comment
setopt noequals               # Enable "=command" feature
setopt no_flow_control    # C-s, C-q„ÇíÁÑ°Âäπ„Å´„Åô„Çã„ÄÇ
setopt clobber            # „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åß‰∏äÊõ∏„Åç„Åô„Çã‰∫ã„ÇíË®±ÂèØ
setopt rm_star_silent     # rm *„ÅÆË≠¶Âëä„ÇíÁÑ°Âäπ„Å´„Åô„Çã
setopt ZLE                #use zsh line editor
# setopt cdablevars             #on: if arguments of cd is not directory, expand as variable.

#jobs
setopt auto_resume            # background job„Çí„Åù„ÅÆ„Ç≥„Éû„É≥„ÉâÂêç„ÅßÂÜçÈñã„Åô„Çã(„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊôÇ‰∏çÂèØ)
setopt notify                 # background job„ÅåÁµÇ‰∫Ü„Åó„Åü„Çâ„Éó„É≠„É≥„Éó„Éà„ÅÆË°®Á§∫„ÇíÂæÖ„Åü„Åö„Å´Áü•„Çâ„Åõ„Çã
setopt check_jobs             # report the background  and suspendedjobs before exit.
setopt long_list_jobs         # jobs -l

#glob
setopt extended_glob
setopt brace_ccl          # {a-c}„Çía b c„Å´Â±ïÈñã„Åô„Çã
setopt no_dot_glob
setopt mark_dirs              # Add "/" when glob.
# setopt nonomatch          #off: „Éû„ÉÉ„ÉÅ„Åó„Å™„Åã„Å£„Åü„Å®„Åç„Ç®„É©„Éº„Å´„Åõ„Åö„Åü„Å†„ÅÆÊñáÂ≠óÂàó„Å®„Åó„Å¶Êâ±„ÅÜ
# setopt numeric_glob_sort  #Êï∞ÂÄ§„ÅåÂê´„Åæ„Çå„Åü„Å®„ÅçÊï∞Â≠óÈ†Ü„Å´„ÇΩ„Éº„Éà„Åô„Çã

#complete
setopt always_lastprompt  #Ë£úÂÆå„ÅßË°å„ÇíÁßªÂãï„Åó„Å™„ÅÑ
setopt list_types         # List like "ls -F"
setopt list_packed        # Ë£úÂÆå„É™„Çπ„Éà„Çí„Å™„Çã„Åπ„ÅèÂ∞ë„Å™„ÅÑÈáè„Å´„Åô„Çã
setopt auto_param_keys    #Ëá™ÂãïË£úÂÆå„Åï„Çå„Çã‰ΩôÂàÜ„Å™„Ç´„É≥„Éû„Å™„Å©„ÇíÈÅ©ÂÆúÂâäÈô§„Åó„Å¶„Çπ„É†„Éº„Ç∫„Å´ÂÖ•Âäõ„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
setopt auto_param_slash   #„Éá„Ç£„É¨„ÇØ„Éà„É™Âêç„ÅÆË£úÂÆå„ÅßÊú´Â∞æ„ÅÆ/„ÇíËá™ÂãïÁöÑ„Å´‰ªòÂä†„Åó„ÄÅÊ¨°„ÅÆË£úÂÆå„Å´ÂÇô„Åà„Çã
setopt auto_remove_slash  #„Çπ„É©„ÉÉ„Ç∑„É•„ÅåË£úÂÆå„Åï„Çå„ÅüÂæå„ÄÅ;„ÇÑ„Çπ„Éö„Éº„Çπ„ÇíÂÖ•Âäõ„Åó„Åü„ÇâËá™ÂãïÁöÑ„Å´„Åù„ÅÆ„Çπ„É©„ÉÉ„Ç∑„É•„ÇíÊ∂à„Åô
setopt magic_equal_subst  # --prefix=/usr/„Å™„Å© = ‰ª•Èôç„ÇÇË£úÂÆå

setopt list_rows_first    # ÂÄôË£ú„ÇíÁßªÂãï„Åô„Çã„Å®„ÅçÊ®™„Å´ÈÄ≤„ÇÄ
setopt no_list_ambiguous  #on: ÂÖ±ÈÄöÈÉ®ÂàÜ„ÇíË£úÂÆå„Åó„Å¶„É™„Çπ„Éà„ÅØË°®Á§∫„Åó„Å™„ÅÑ

# auto_list auto_menu bash_auto_list glob_complete hash_list_all list_ambiguous menu_complete rec_exact
# setopt auto_menu          # TAB„ÅßÂÄôË£ú„ÇíÈÅ∏Êäû„Åß„Åç„Çã„É°„Éã„É•„Éº(2typeÂøÖË¶Å)
# setopt auto_list          # Ë£úÂÆåÂÄôË£ú‰∏ÄË¶ß„ÇíPAGERÁöÑ„Å™„ÇÇ„ÅÆ„ÅßË°®Á§∫„Åô„Çã
# setopt no_menu_complete   #

# }}}

#zgen # {{{
zgen_path="$HOME/.zgen"
if [[ ! -e ${zgen_path:-} ]]; then
  local key
  if read -q key'?install zgen?(y/N) '; then
    echo
    git clone https://github.com/tarjoilija/zgen.git "${zgen_path}"
  fi
  unset key
fi

if [[ -d ${zgen_path:-} ]]; then
  source "${zgen_path}/zgen.zsh"
  if ! zgen saved; then
    zgen load m4i/cdd
    # zgen load junegunn/fzf      # command
    # zgen load Russell91/sshrc   # command
    # zgen load philovivero/distribution # command

    zgen load mollifier/zload # reload zsh completion function.
    # zgen load b4b4r07/auto-fu.zsh
    zgen load zsh-users/zsh-syntax-highlighting
    zgen load zsh-users/zsh-completions src

    zgen oh-my-zsh plugins/gem
    zgen oh-my-zsh plugins/docker
    zgen save
  fi
  source $HOME/.zgen/m4i/cdd-master/cdd
  # source $HOME/.zgen/tcnksm/docker-alias-master/zshrc
fi
unset zgen_path
# }}}

#zplug # {{{
# zplug_path="$HOME/.zplug"
if [[ ! -d ${zplug_path:-.} ]]; then

  if read -q key'?install zplug?(y/N) '; then
    echo; git clone https://github.com/b4b4r07/zplug.git "${zplug_path}"
  fi
  unset key
fi

if [[ -d ${zplug_path:-} ]]; then
  export ZPLUG_LOADFILE="$ZSH_DOT_DIR/zplug.zsh"
  source "${zplug_path}/init.zsh"

  zplug check --verbose
  zplug load # TODO: Call compinit again.

  alias zplug-clear='zplug clean; zplug clear; rm ~/.{,zplug/}zcompdump'
  in_path k && alias k='k -Ah'
  in_path distribution && alias distribution='distribution --color'
fi
unset zplug_path
# }}}

# NOTE: call by zplug one time.
#zsh completion system
# autoload -U compinit

# -u disable security check.
# compinit -u

# compdef _cdd cdd # NOTE: call by zplug.

#requrie after compinit
source "$ZSH_DOT_DIR/zsh.completion"

can_exec _cdd_chpwd && add-zsh-hook chpwd _cdd_chpwd

# title
title-cmd(){ title "${1}" }
title-dir(){ title "${PWD}" }
add-zsh-hook preexec title-cmd
add-zsh-hook chpwd title-dir

# cdr # {{{
autoload -Uz chpwd_recent_dirs cdr
add-zsh-hook chpwd chpwd_recent_dirs
zstyle ':chpwd:*' recent-dirs-max 500
zstyle ':chpwd:*' recent-dirs-default true
zstyle ':chpwd:*' recent-dirs-pushd true
zstyle ':chpwd:*' recent-dirs-file "$HOME/.zsh/chpwd-recent-dirs"
zstyle ':completion:*:*:cdr:*' menu select
# }}}

# highlighting # {{{
# ZSH_HIGHLIGHT_STYLES[default]='none'
# ZSH_HIGHLIGHT_STYLES[unknown-token]='fg=red,bold'
# ZSH_HIGHLIGHT_STYLES[reserved-word]='fg=yellow'
# ZSH_HIGHLIGHT_STYLES[suffix-alias]='fg=green,underline'
# ZSH_HIGHLIGHT_STYLES[precommand]='fg=green,underline'
# ZSH_HIGHLIGHT_STYLES[commandseparator]='none'
ZSH_HIGHLIGHT_STYLES[path]='fg=85'
# ZSH_HIGHLIGHT_STYLES[path_pathseparator]=''
# ZSH_HIGHLIGHT_STYLES[path_prefix_pathseparator]=''
ZSH_HIGHLIGHT_STYLES[globbing]='fg=51'
# ZSH_HIGHLIGHT_STYLES[history-expansion]='fg=blue'
# ZSH_HIGHLIGHT_STYLES[single-hyphen-option]:=none
# ZSH_HIGHLIGHT_STYLES[double-hyphen-option]:=none
# ZSH_HIGHLIGHT_STYLES[assign]:=none
# ZSH_HIGHLIGHT_STYLES[redirection]:=none
# ZSH_HIGHLIGHT_STYLES[comment]:=fg=black,bold
# ZSH_HIGHLIGHT_STYLES[arg0]:=fg=green

ZSH_HIGHLIGHT_STYLES[back-quoted-argument]='fg=green'
ZSH_HIGHLIGHT_STYLES[single-quoted-argument]='fg=87'
ZSH_HIGHLIGHT_STYLES[double-quoted-argument]='fg=154'
# ZSH_HIGHLIGHT_STYLES[dollar-quoted-argument]='fg=yellow'
ZSH_HIGHLIGHT_STYLES[dollar-double-quoted-argument]='fg=214'
# ZSH_HIGHLIGHT_STYLES[back-double-quoted-argument]='fg=cyan'
# ZSH_HIGHLIGHT_STYLES[back-dollar-quoted-argument]='fg=cyan'

ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets pattern)
ZSH_HIGHLIGHT_PATTERNS+=('rm -r *' 'fg=white,bold,bg=red')
# }}}

source "$ZSH_DOT_DIR/zsh.functions"
source "$ZSH_DOT_DIR/zsh.aliases"

#zstyle completion {{{
# zstyle ':completion:*:*:CMD:*:TAG' STYLE
zstyle ':completion:*' group-name ''
zstyle ':completion:*' verbose true
zstyle ':completion:*:options' verbose true
zstyle ':completion:*:values' verbose true
zstyle ':completion:*' menu select=1 # ÁèæÂú®„ÅÆË£úÂÆåÂÄôË£ú„Çí„Éè„Ç§„É©„Ç§„Éà
zstyle ':completion:*' list-separator '~~>'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' list-prompt '%S%F{197}   Hey Hey! %p   %f%s'
zstyle ':completion:*' select-prompt '%S%F{208}  Œµ=Œµ=Œµ=Œµ=Ôºº(;¬¥‚ñ° `)/ %p  %f%s'
zstyle ':completion:*' matcher-list '' 'm:{a-z}={A-Z}' 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=* l:|=*'

zstyle ':completion:*:descriptions' format '%F{43}%d%f'
zstyle ':completion:*:messages'     format '%F{227}%d%f'
zstyle ':completion:*:warnings'     format '%F{red}Sorry, no matches for%f: %d'

#kill Áï™Âè∑Ëâ≤‰ªò„Åç nolist interactive
zstyle ':completion:*:*:kill:*' list-colors '=(#b) #([0-9]#)*=0=38;05;162'
zstyle ':completion:*:*:kill:*' menu true interactive
zstyle ':completion:*:*:kill:*' command 'ps --no-headers -u "${USER}" -o pid,%cpu,tty,cputime,cmd'

zstyle ':completion:*:*:sudo:*' command-path /usr/local/sbin /usr/local/bin /usr/sbin /usr/bin /sbin /bin /usr/X11R6/bin
zstyle ':completion:*:*:-subscript-:*' tag-order indexes parameters   # complete array index.

# setopt noautolist
setopt no_menu_complete
setopt autolist
setopt automenu
# }}}

#bindkey # {{{
bindkey -e
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey -r "^T"

# emacs bind # {{{
bindkey "^A" beginning-of-line
bindkey "^E" end-of-line
bindkey "^F" forward-char
bindkey "^B" backward-char
bindkey "^D" delete-char
bindkey "^H" backward-delete-char
bindkey "^W" backward-kill-word
bindkey "^K" kill-line
bindkey "^U" backward-kill-line
bindkey "^N" down-line-or-history
bindkey "^P" up-line-or-history
# }}}

bindkey "^L" clear-screen
bindkey "^M" accept-line
bindkey "^J" accept-line
bindkey "^G" send-break
bindkey "^Q" push-line
bindkey "^V" quoted-insert

bindkey "^I" expand-or-complete
bindkey "^O" accept-line-and-down-history
bindkey "^Y" yank
bindkey "^]" insert-last-word

# \ -
bindkey "^_" undo
# insert
bindkey "[2~" overwrite-mode
# delete
bindkey "[3~" delete-char
# backspace
bindkey "^?" backward-delete-char

# <S-Tab>
bindkey "[Z" reverse-menu-complete

bindkey "^X^X" edit-command-line

# cursor-key and other # {{{
bindkey "[A" up-line-or-history
bindkey "[B" down-line-or-history
bindkey "[C" forward-char
bindkey "[D" backward-char
bindkey "[H" beginning-of-line
bindkey "[F" end-of-line
bindkey "OA" up-line-or-history
bindkey "OB" down-line-or-history
bindkey "OC" forward-char
bindkey "OD" backward-char
bindkey "OH" beginning-of-line
bindkey "OF" end-of-line
# }}}

# alt-bind # {{{
bindkey "b" backward-word
bindkey "f" forward-word
bindkey "n" history-search-forward
bindkey "p" history-search-backward

bindkey "w" kill-word
bindkey "q" push-line
bindkey "h" run-help
# }}}

  ## original keybind functions # {{{
  zle_filter_history(){
    zle reset-prompt
    local cmd="$(history -nr 0 | peco --query "${LBUFFER}")"

    if [[ -n $cmd ]]; then
      BUFFER="${cmd}"
      CURSOR=$#BUFFER
    fi
  }
  zle -N zle_filter_history
  in_path peco && bindkey '' zle_filter_history

  zle_filter_cdr(){
    zle reset-prompt
    local dir="$(cdr -l | sed 's/^[^ ]\+ \+//' | peco --query "${LBUFFER}")"

    if [[ -n $dir ]]; then
      BUFFER="cd ${dir}"
      zle accept-line
    fi
  }
  zle -N zle_filter_cdr
  in_path peco && bindkey '' zle_filter_cdr

  zle_filter_select_file(){
    zle reset-prompt
    local -a array
    array+=${(z)LBUFFER}
    shift array

    local dir file file_path
    dir="${$(relative "$array[-1]"):-.}"
    file="$(cd "$dir" &>/dev/null && find -type d -name .git -prune -o -type f 2>/dev/null | sed 's|^\./||' | sort | peco)"
    file_path="$(relative "$dir/$file")"

    if [[ -n $file ]]; then
      BUFFER="${BUFFER%"$array[-1]"}$file_path"
      CURSOR=${#BUFFER}
    fi
  }
  zle -N zle_filter_select_file
  bindkey '' zle_filter_select_file

  # TODO „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÊµÖ„Åï„Åß„ÇΩ„Éº„Éà
  zle_filter_open_file(){
    zle reset-prompt
    # zle„ÅßÂëº„Å∞„Çå„Çã„Å®hook„ÅåÂëº„Å∞„Çå„Çã
    file="$({filter_select_file})"
    if [[ -n $file ]]; then
      BUFFER="${EDITOR} '${file}'"
      CURSOR=${#BUFFER}
      zle accept-line
    fi
  }
  zle -N zle_filter_open_file
  # Ctrl /
  bindkey '' zle_filter_open_file

  zle_git_hash(){
    BUFFER="${BUFFER} $(git log --oneline --branches | peco | awk '{print $1}')"
    CURSOR=${#BUFFER}
  }
  zle -N zle_git_hash
  bindkey 'g' zle_git_hash

  zle_play_music(){
    zle reset-prompt
    play-music </dev/tty
  }
  zle -N zle_play_music
  bindkey 'm' zle_play_music
  bindkey '' zle_play_music

  zle_filter_commands(){
    BUFFER="$(hash -L | awk -F'[= ]' '{print $2}' | peco --initial-filter=Fuzzy)"
    CURSOR=${#BUFFER}
  }
  zle -N zle_filter_commands
  bindkey 'c' zle_filter_commands
  # bindkey '' zle_filter_commands # don't work

  zle_filter_cd(){
    local str=' '
    while [[ -n $str && $str != '.' ]]; do
      str="$(find -maxdepth 1 -type d | sed 's|^./||'| peco)"
      cd "${str}"
    done
    BUFFER="cd $(pwd)"
    zle accept-line
  }
  zle -N zle_filter_cd
  bindkey 'd' zle_filter_cd
  # bindkey '' zle_filter_cd # don't work

  zle_pry(){
    BUFFER=pry
    zle accept-line
  }
  zle -N zle_pry
  bindkey 'p' zle_pry
  bindkey '' zle_pry

  zle_clip(){
    echo -nE "${BUFFER}" | clip
  }
  zle -N zle_clip
  bindkey 'y' zle_clip

  # }}}
# }}}

can_exec zprof && zprof

#Load local config
exists_source "$ZSH_DOT_DIR/zshrc.local"
